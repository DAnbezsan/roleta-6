<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Roleta Premiada</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root{
  --gold1:#FFF5C3;
  --gold2:#FFD95A;
  --gold3:#C6A700;
  --gold4:#7a6200;
  --black1:#000000;
  --black2:#222222;
}
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#0f0f10;
  margin:0;padding:0;
  display:flex;flex-direction:column;align-items:center;color:#fff;
}
h2{margin:18px 0;text-shadow:0 0 10px rgba(255,215,0,0.25)}
.wheel-container{position:relative;display:inline-block}
canvas{border-radius:50%;box-shadow:0 18px 40px rgba(0,0,0,0.45);background:#111;display:block}
.arrow{position:absolute;top:-26px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:15px solid transparent;border-right:15px solid transparent;border-bottom:28px solid #c0392b}
#spinBtn{margin:18px;padding:12px 26px;font-size:18px;border:none;border-radius:10px;background:linear-gradient(45deg,var(--gold2),var(--gold3));color:#000;font-weight:700;cursor:pointer;box-shadow:0 0 18px rgba(255,215,0,0.25)}
#spinBtn:disabled{background:#666;color:#ddd;cursor:not-allowed}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}
.modal-content{background:#fff;padding:18px;border-radius:10px;text-align:center;width:88%;max-width:360px;color:#000}
input{padding:10px;width:92%;margin-bottom:10px;border:1px solid #ccc;border-radius:8px;font-size:16px}
button{padding:10px 18px;border:none;border-radius:8px;background:#007bff;color:#fff;font-size:16px;cursor:pointer}
.close-btn{margin-top:12px;background:#111;color:#fff}
.info-section{max-width:680px;text-align:left;margin:18px;padding:14px;background:#fff;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,0.08);color:#000}
.info-section h3{margin-bottom:8px}
.info-section p{margin:6px 0}
@media (max-width:420px){ canvas{width:320px;height:320px} }
</style>
</head>
<body>
<h2>Roleta Premiada</h2>

<div class="wheel-container">
  <canvas id="wheel" width="360" height="360" aria-label="Roleta"></canvas>
  <div class="arrow" aria-hidden="true"></div>
</div>

<button id="spinBtn">Girar</button>

<!-- Modal telefone -->
<div id="phoneModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3>Digite seu telefone</h3>
    <input id="phoneInput" placeholder="DDD + n√∫mero (somente d√≠gitos)" maxlength="13" />
    <button id="savePhoneBtn">Salvar</button>
  </div>
</div>

<!-- Modal resultado -->
<div id="resultModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h2 id="resultTitle" style="margin:6px 0;font-size:20px;color:#000"></h2>
    <div id="qrcode" style="margin:10px auto;width:120px;height:120px;"></div>
    <button class="close-btn" id="closeRes">Fechar</button>
  </div>
</div>

<section class="info-section">
  <h3>Como participar:</h3>
  <p>1. Insira seu telefone no campo acima.</p>
  <p>2. Clique em "Girar" para ver seu pr√™mio.</p>
  <p>3. Mostre o cupom gerado na recep√ß√£o.</p>

  <h3>Regras:</h3>
  <p>- Cada telefone pode girar apenas uma vez (exceto o n√∫mero ADM).</p>
  <p>- Promo√ß√£o v√°lida at√© <strong>10 de janeiro</strong>.</p>
  <p>- Pr√™mios sujeitos √† disponibilidade.</p>

  <h3>Contato:</h3>
  <p>WhatsApp: +55 77 98163-3924</p>
</section>

<script>
/* ---------- CONFIG ---------- */
const ADMIN_PHONE = "77998652620";       // n√∫mero liberado para testes
const ADMIN_TAG = "ADM";
const WHATSAPP_TARGET = "77981633924";   // sem o +55 no envio via wa.me aqui (server uses)
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIjpHdsFx0TyHRs8YDe7fZlJ0l88SPQRklLu2QTMquIeHvvMuIr01ZRY-8GQi7yzXx/exec";

/* ---------- PRIZES (fixed order) ---------- */
const prizes = [
  {label:'DESIGN SIMPLES 50%'},
  {label:'FIO A FIO 50%'},
  {label:'SHADOW LINE 50%'},
  {label:'DESIGN SIMPLES 100%'},
  {label:'FIO A FIO 100%'},
  {label:'SHADOW LINE 100%'}
];

const prizesSequence = [
'DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%',
'FIO A FIO 50%','FIO A FIO 50%','FIO A FIO 50%',
'DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%',
'SHADOW LINE 50%','SHADOW LINE 50%',
'DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%',
'FIO A FIO 50%','FIO A FIO 50%','FIO A FIO 50%',
'DESIGN SIMPLES 50%','DESIGN SIMPLES 50%','DESIGN SIMPLES 50%',
'FIO A FIO 50%','FIO A FIO 50%',
'SHADOW LINE 100%',
'DESIGN SIMPLES 100%','DESIGN SIMPLES 100%',
'DESIGN SIMPLES 50%','DESIGN SIMPLES 50%',
'SHADOW LINE 50%','SHADOW LINE 50%',
'FIO A FIO 100%',
'FIO A FIO 50%','FIO A FIO 50%',
'DESIGN SIMPLES 100%','DESIGN SIMPLES 100%','DESIGN SIMPLES 100%',
'SHADOW LINE 50%',
'DESIGN SIMPLES 100%','DESIGN SIMPLES 100%',
'FIO A FIO 100%'
];

/* ---------- CANVAS & DRAW (perfect alternation + 3D gold) ---------- */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx, cy) - 12;

function goldGradient(startAngle, endAngle){
  const g = ctx.createRadialGradient(0, 0, r*0.15, 0, 0, r);
  g.addColorStop(0, '#FFF9E6');
  g.addColorStop(0.25, '#FFD95A');
  g.addColorStop(0.6, '#C6A700');
  g.addColorStop(1, '#6f5600');
  return g;
}
function blackGradient(startAngle, endAngle){
  const g = ctx.createLinearGradient(Math.cos(startAngle)*r*0.2, Math.sin(startAngle)*r*0.2, Math.cos(endAngle)*r*0.9, Math.sin(endAngle)*r*0.9);
  g.addColorStop(0, '#666666');
  g.addColorStop(0.5, '#222222');
  g.addColorStop(1, '#000000');
  return g;
}

function drawWheel(rotation = 0){
  const c = prizes.length, a = 2*Math.PI / c;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(rotation);

  // outer rim shine
  ctx.beginPath();
  ctx.arc(0,0,r+8,0,2*Math.PI);
  const rimG = ctx.createRadialGradient(0,0,r*0.6,0,0,r+8);
  rimG.addColorStop(0,'rgba(255,255,255,0.12)');
  rimG.addColorStop(1,'rgba(0,0,0,0.35)');
  ctx.fillStyle = rimG;
  ctx.fill();

  for(let i=0;i<c;i++){
    const s = i*a, e = s + a;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r,s,e);

    // enforce strict alternation: 0=black,1=gold,2=black,...
    const isGold = (i % 2 === 1);
    if(isGold) ctx.fillStyle = goldGradient(s,e);
    else ctx.fillStyle = blackGradient(s,e);
    ctx.fill();

    // divider line
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 1.6;
    ctx.stroke();

    // text
    ctx.save();
    const mid = s + a/2;
    ctx.rotate(mid);
    ctx.translate(0, -r*0.56);
    ctx.rotate(Math.PI/2);
    ctx.font = "bold 12px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = isGold ? '#000000' : '#FFD700';
    drawWrappedText(ctx, prizes[i].label, 0, 0, 110);
    ctx.restore();
  }

  // center hub + highlight
  ctx.beginPath();
  ctx.arc(0,0,r*0.12,0,2*Math.PI);
  const hub = ctx.createRadialGradient(0,0,2,0,0,r*0.12);
  hub.addColorStop(0,'#fff'); hub.addColorStop(0.6,'rgba(255,255,255,0.2)'); hub.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle = hub; ctx.fill();
  ctx.beginPath(); ctx.arc(0,0,9,0,2*Math.PI); ctx.fillStyle='#b80000'; ctx.fill();

  ctx.restore();
}

function drawWrappedText(ctx, text, x, y, maxWidth){
  if(ctx.measureText(text).width <= maxWidth){ ctx.fillText(text,x,y); return; }
  const parts = text.split(' '); let line='', lines=[];
  for(let n=0;n<parts.length;n++){
    const testLine = line + (line ? ' ' : '') + parts[n];
    if(ctx.measureText(testLine).width > maxWidth && line){
      lines.push(line); line = parts[n];
    } else line = testLine;
  }
  if(line) lines.push(line);
  const offset = (lines.length - 1) * -8;
  for(let i=0;i<lines.length;i++) ctx.fillText(lines[i], x, y + offset + i*16);
}

drawWheel();

/* ---------- LOGIC: spinning, index, blocks ---------- */
let spinning = false;
let currentIndex = parseInt(localStorage.getItem('currentIndex') || '0', 10);
let usedPhones = JSON.parse(localStorage.getItem('usedPhones') || '[]');
let hasSpun = localStorage.getItem('hasSpun') === 'true';

function checkEnd(){
  if(currentIndex >= prizesSequence.length){
    document.getElementById('spinBtn').disabled = true;
    alert('üèÅ Todos os pr√™mios j√° foram sorteados ‚Äî aguarde o reset.');
    return true;
  }
  return false;
}
checkEnd();

document.getElementById('spinBtn').addEventListener('click', () => {
  if(spinning) return;
  if(checkEnd()) return;

  const phone = localStorage.getItem('wheelPhone');
  if(!phone){
    document.getElementById('phoneModal').style.display = 'flex';
    return;
  }

  // admin bypass: admin can spin unlimited
  if(hasSpun && phone !== ADMIN_PHONE){
    alert('Voc√™ j√° participou desta promo√ß√£o neste dispositivo.');
    return;
  }
  if(phone !== ADMIN_PHONE && usedPhones.includes(phone)){
    alert('Este n√∫mero j√° participou da promo√ß√£o.');
    return;
  }

  // start spin based on fixed sequence
  spinning = true;
  const targetLabel = prizesSequence[currentIndex];
  const prizeIndex = prizes.findIndex(p => p.label === targetLabel);
  // keep the same rotation math so wheel lands on prizeIndex
  const spins = 4 + Math.floor(Math.random()*3);
  const degreesPerSector = 360 / prizes.length;
  const offset = Math.random()*(degreesPerSector-6) - (degreesPerSector/2 - 3);
  const totalDeg = spins*360 + 360 - (prizeIndex*degreesPerSector + degreesPerSector/2) + offset;
  const start = performance.now();
  const duration = 4200 + Math.random()*1200;

  function animate(now){
    const t = Math.min(1, (now - start)/duration);
    const ease = 1 - Math.pow(1 - t, 3);
    const curDeg = totalDeg * ease;
    drawWheel(curDeg * Math.PI/180);
    if(t < 1) requestAnimationFrame(animate);
    else {
      spinning = false;
      currentIndex++;
      localStorage.setItem('currentIndex', currentIndex);
      const phoneVal = localStorage.getItem('wheelPhone') || '';
      const isAdmin = (phoneVal === ADMIN_PHONE);
      if(!isAdmin){
        hasSpun = true;
        localStorage.setItem('hasSpun', 'true');
        usedPhones.push(phoneVal);
        localStorage.setItem('usedPhones', JSON.stringify(usedPhones));
      }
      showResult(targetLabel, phoneVal);
      sendToSheets(phoneVal, targetLabel, isAdmin ? ADMIN_TAG : 'N√ÉO');

      if(currentIndex >= prizesSequence.length){
        document.getElementById('spinBtn').disabled = true;
        setTimeout(()=>{ alert('üèÅ Todos os pr√™mios j√° foram sorteados ‚Äî aguarde o reset.'); }, 600);
      }
    }
  }
  requestAnimationFrame(animate);
});

/* ---------- RESULT (modal + WhatsApp) ---------- */
function showResult(label, phone){
  const modal = document.getElementById('resultModal');
  document.getElementById('resultTitle').textContent = label;
  modal.style.display = 'flex';
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById("qrcode"), { text: window.location.href, width:120, height:120 });

  // open WhatsApp after slight delay
  const owner = WHATSAPP_TARGET;
  const userPhone = phone || localStorage.getItem('wheelPhone') || 'N√£o informado';
  const msg = `Ol√°! Acabei de ganhar ${label} na roleta premiada!\nTelefone: ${userPhone}`;
  setTimeout(()=>{ window.open(`https://wa.me/${owner}?text=${encodeURIComponent(msg)}`, '_blank'); }, 800);
}

/* ---------- SEND TO SHEETS (beacon or fetch no-cors) ---------- */
function sendToSheets(phone, prize, adminFlag){
  try{
    const payload = {
      phone: phone ? (phone + (adminFlag === ADMIN_TAG ? ' ('+ADMIN_TAG+')' : '')) : '',
      prize: prize,
      date: new Date().toISOString(),
      admin_test: adminFlag
    };
    const body = JSON.stringify(payload);
    if(navigator.sendBeacon){
      navigator.sendBeacon(GOOGLE_SCRIPT_URL, body);
    } else {
      // mode no-cors used because Apps Script may not return CORS headers for POST
      fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body }).catch(()=>{});
    }
  }catch(e){
    console.warn('Erro ao enviar para Sheets', e);
  }
}

/* ---------- MODALS & PHONE SAVE ---------- */
document.getElementById('closeRes').addEventListener('click', ()=> document.getElementById('resultModal').style.display='none');

document.getElementById('savePhoneBtn').addEventListener('click', ()=>{
  const raw = document.getElementById('phoneInput').value.trim().replace(/\D/g,'');
  if(!/^\d{10,13}$/.test(raw)){ alert('Digite um telefone v√°lido (somente d√≠gitos, 10‚Äì13 caracteres)'); return; }
  localStorage.setItem('wheelPhone', raw);
  document.getElementById('phoneModal').style.display='none';
  alert('Telefone salvo! Agora voc√™ pode girar a roleta.');
  // Option A: allow immediate spin (no further click required beyond pressing "Girar")
});

/* ---------- ADMIN TOUCH-LONG (open dashboard) ---------- */
let pressTimer;
const titleEl = document.querySelector('h2');
titleEl.addEventListener('touchstart', ()=> { pressTimer = setTimeout(()=>{ openAdmin(); }, 5000); });
titleEl.addEventListener('touchend', ()=> clearTimeout(pressTimer));
titleEl.addEventListener('mousedown', ()=> { pressTimer = setTimeout(()=>{ openAdmin(); }, 5000); });
titleEl.addEventListener('mouseup', ()=> clearTimeout(pressTimer));
function openAdmin(){ const pwd = prompt('Digite a senha de administrador:'); if(pwd === 'adm0832'){ window.open('dashboard.html','_blank'); } else alert('Senha incorreta.'); }

/* ---------- init ---------- */
(function(){ drawWheel(); })();
</script>
</body>
</html>
