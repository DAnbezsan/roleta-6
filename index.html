<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Roleta Premiada</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  body{font-family:Arial;background:#f7f7f7;margin:0;padding:0;display:flex;flex-direction:column;align-items:center}
  h2{margin-top:20px}
  .wheel-container{position:relative;display:inline-block;margin-top:20px}
  canvas{background:#fff;border-radius:50%;box-shadow:0 0 10px rgba(0,0,0,0.2)}
  .arrow{position:absolute;top:-25px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:15px solid transparent;border-right:15px solid transparent;border-bottom:25px solid red}
  #spinBtn{margin:20px;padding:12px 24px;font-size:18px;border:none;border-radius:8px;background:#4CAF50;color:#fff;cursor:pointer}
  #spinBtn:disabled{background:#888;cursor:not-allowed}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}
  .modal-content{background:#fff;padding:20px;border-radius:10px;text-align:center;width:85%;max-width:320px}
  input{padding:10px;width:90%;margin-bottom:10px;border:1px solid #ccc;border-radius:8px;font-size:16px}
  button{padding:10px 18px;border:none;border-radius:8px;background:#007bff;color:#fff;font-size:16px;cursor:pointer;margin-top:4px}
  .close-btn{margin-top:12px;background:#000;color:#fff}
</style>
</head>
<body>
<h2>Roleta Premiada</h2>

<div class="wheel-container">
  <canvas id="wheel" width="320" height="320"></canvas>
  <div class="arrow"></div>
</div>

<button id="spinBtn">Girar</button>

<!-- Modal telefone -->
<div id="phoneModal" class="modal">
  <div class="modal-content">
    <h3>Digite seu telefone</h3>
    <input id="phoneInput" placeholder="DDD + número" maxlength="13" />
    <button id="savePhoneBtn">Salvar</button>
  </div>
</div>

<!-- Modal resultado -->
<div id="resultModal" class="modal">
  <div class="modal-content">
    <h2 id="resultTitle" style="margin:6px 0;font-size:20px;color:#000"></h2>
    <div id="qrcode" style="margin:10px auto;width:120px;height:120px;"></div>
    <button class="close-btn" id="closeRes">Fechar</button>
  </div>
</div>

<script>
const prizes = [
  {label:'DESIGN SIMPLES 50%', color:'#000000'},
  {label:'FIO A FIO 50%', color:'#000000'},
  {label:'SHADOW LINE 50%', color:'#FFD700'},
  {label:'DESIGN SIMPLES 100%', color:'#FFD700'},
  {label:'FIO A FIO 100%', color:'#000000'},
  {label:'SHADOW LINE 100%', color:'#FFD700'}
];

const canvas=document.getElementById('wheel');
const ctx=canvas.getContext('2d');
const cx=canvas.width/2,cy=canvas.height/2,r=Math.min(cx,cy)-8;

function drawWheel(rotation = 0) {
  const arc = (2 * Math.PI) / prizes.length;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(rotation);

  for (let i = 0; i < prizes.length; i++) {
    const start = i * arc;
    const end = start + arc;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, r, start, end);
    ctx.fillStyle = prizes[i].color;
    ctx.fill();
    ctx.stroke();

    ctx.save();
    ctx.rotate(start + arc / 2);
    ctx.translate(r * 0.65, 0);
    ctx.rotate(-rotation - start - arc / 2);
    ctx.fillStyle = prizes[i].color === "#FFD700" ? "#000" : "#FFD700";
    ctx.font = "bold 14px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(prizes[i].label, 0, 0);
    ctx.restore();
  }

  ctx.beginPath();
  ctx.fillStyle = "red";
  ctx.arc(0, 0, 10, 0, 2 * Math.PI);
  ctx.fill();
  ctx.restore();
}
drawWheel();

let spinning=false;
let hasSpun = localStorage.getItem("wheelHasSpun") === "true";
let usedPhones = JSON.parse(localStorage.getItem("usedPhones") || "[]");
let currentRotation = 0;

document.getElementById('spinBtn').addEventListener('click',()=>{
  if(spinning) return;
  if(hasSpun){alert('Você já participou desta promoção neste dispositivo.'); return;}
  const phone=localStorage.getItem('wheelPhone');
  if(!phone){document.getElementById('phoneModal').style.display='flex'; return;}
  if(usedPhones.includes(phone)){alert('Este número já participou da promoção.'); return;}

  spinning=true;
  const prizeIndex = Math.floor(Math.random() * prizes.length);
  const spins = 5;
  const totalRotation = spins * 2 * Math.PI + (Math.PI * 3/2) - (prizeIndex * (2*Math.PI/prizes.length)) - (Math.PI/prizes.length);
  const start = performance.now();
  const duration = 4000;

  function animate(time){
    const t = Math.min(1,(time-start)/duration);
    const ease = 1-Math.pow(1-t,3);
    currentRotation = totalRotation * ease;
    drawWheel(currentRotation);
    if(t<1){requestAnimationFrame(animate);}else{
      spinning=false;
      hasSpun = true;
      localStorage.setItem("wheelHasSpun", "true");
      usedPhones.push(phone);
      localStorage.setItem("usedPhones", JSON.stringify(usedPhones));
      showResult(prizes[prizeIndex].label);
    }
  }
  requestAnimationFrame(animate);
});

function showResult(label){
  const modal = document.getElementById('resultModal');
  document.getElementById('resultTitle').textContent = label;
  modal.style.display = 'flex';
  document.getElementById('qrcode').innerHTML = '';

  new QRCode(document.getElementById("qrcode"), {
    text: window.location.href,
    width: 120,
    height: 120
  });

  // Enviar mensagem automática via WhatsApp
  const phoneNumber = "77981633924"; // número fixo do seu WhatsApp
  const message = encodeURIComponent(`Olá! Acabei de ganhar ${label} na roleta premiada!`);
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;

  // Abrir em nova aba após pequeno atraso (para usuário ver o resultado)
  setTimeout(() => {
    window.open(whatsappUrl, '_blank');
  }, 2500);
}

  
document.getElementById('closeRes').addEventListener('click',()=>document.getElementById('resultModal').style.display='none');

document.getElementById('savePhoneBtn').addEventListener('click',()=>{
  const v=document.getElementById('phoneInput').value.trim();
  if(!/^\d{10,13}$/.test(v)){alert('Digite um telefone válido com DDD'); return;}
  localStorage.setItem('wheelPhone',v);
  document.getElementById('phoneModal').style.display='none';
  alert('Telefone salvo! Agora você pode girar a roleta.');
});
</script>
</body>
</html>
